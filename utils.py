import sys, re

def arbitrationID_toHex(arbitrationID:int):
    """Converts an arbitration id in provided int form to hex

    Args:
        arbitrationID (int): arbitration id directly from the unedited .dbc file (not generated by this code)

    Returns:
        int: arbitration id in hex form, which in Python, is an int under the hood
    """
    # Convert to hex
    hexID = hex(int(arbitrationID))
    # Convert MSB to 1
    hexID = "0x1" + hexID[3:]
    # Convert string to hex value
    hexID = int(hexID, 16)
    # print(hexID)  # Debug
    return hexID

def scrape_dbc_for_gateways(filePath:str):
    """This function will scrape a provided `.dbc` file for all gateways, and put them in a new `.dbc` file named `scrapedGateways.dbc`.
    If the `scrapedGateways.dbc` already exists, user will be prompted before running the program to avoid overwriting existing content.
    
    Note that arbitration IDs will be displayed as integers, but hex numbers are ultimately int types under the hood in Python.

    Args:
        filePath (str): The filepath (absolute or local) of the `.dbc` file to be scraped
    """    
    try:
        dbcFile = open(filePath, 'r')
        # If we could not open the file
    except OSError:
        print("Error: could not open/read file ", filePath)
        sys.exit()
    
    # Appending 'scrapedGateways_to the provided .dbc filename 
    scrapedName = "scrapedGateways_" + filePath.split('/')[-1]
    
    try:
        scrapedGatewaysFile = open(scrapedName, 'w')
    except OSError:
        print("Error: could not open scrapedGatewayFile")
        sys.exit()
    
    with dbcFile, scrapedGatewaysFile:
        # Get the first line (fencepost problem)
        curLineRaw = dbcFile.readline()
        while curLineRaw: # While there's still a line in the file
            # Splitting by double quotes, rather than spaces, makes things slightly easier
            curLineParsed = curLineRaw.split('"')
            # All gateways necessarily start with 'BA_ "Network"'
            # Note that not every line with 'BA_ "Network"' is a gateway
            if len(curLineParsed) > 2 and curLineParsed[0].strip() == "BA_" and curLineParsed[1].strip() == "Network":
                # Because we parsed by double quotes, the very last element in the array of
                # tokens will be a semicolon, and the second to last element will be the
                # specified CAN channel (port?)
                
                # It is a gateway if and only if a colon is present
                if re.match(r".+:", curLineParsed[3]):
                    # Get arbitration ID of this gateway
                    arbitrationID = re.search(r"\d+", curLineParsed[2])
                    # re.search() returns an object, we just want the string
                    if arbitrationID: arbitrationID = arbitrationID.string
                    # We just want the number
                    arbitrationID = arbitrationID.split(" ")[2].strip()
                    # print(arbitrationID)  # Debug
                    # Note that in python, hex numbers are ints under the hood
                    # arbitrationID = arbitrationID_toHex(arbitrationID)
                    
                    # In case there are multiple gateways
                    allGateways = curLineParsed[3].split(",")
                    # print(allGateways)  # Debug
                    
                    '''
                        We now have everything we need
                        scrapedGatewayFile format:
                        arbitrationID;gateway gateway gateway ...
                    '''
                    scrapedGatewaysFile.write(str(arbitrationID))
                    scrapedGatewaysFile.write(";")
                    for gateway in allGateways:
                        scrapedGatewaysFile.write(gateway.strip())
                        scrapedGatewaysFile.write(" ")
                    scrapedGatewaysFile.write("\n")
                
                '''
                    All gateway specifications start with 'BA_', followed by
                    ' "Network" ', 
                    matches this regex { \d ".*:.*"; }
                    
                '''
                # match = re.search(r'\d ".*:.*";', curLineRaw)
                
            curLineRaw = dbcFile.readline()
            

    
                
if __name__ == "__main__":
    if len(sys.argv) > 1:
        if (sys.argv[1] == "gateway.dbc"):
            userInput = input("Caution: if 'scrapedGateways_" + sys.argv[2] + "' already exists,\nit will be overwritten. Proceed? [y/n]")
            if userInput.lower() == 'y':
                inputFilePath = sys.argv[2]
                scrape_dbc_for_gateways(inputFilePath)
        elif (sys.argv[1] == "hex"):
           arbitrationID_toHex(int(sys.argv[2])) 
    else:
        print("Utils: Pass an argument bro")